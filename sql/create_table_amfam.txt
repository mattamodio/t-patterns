DROP TABLE `WORKING_TABLE`;

CREATE TABLE `WORKING_TABLE` (`id` int(11) unsigned NOT NULL AUTO_INCREMENT,`observation_period` int(11) DEFAULT NULL,`event_type` varchar(500) DEFAULT NULL,`observation_period_T` int(11) DEFAULT NULL,`time_start` int(11) DEFAULT NULL,`time_end` int(11) DEFAULT NULL,`happiness` int(11) DEFAULT NULL,PRIMARY KEY (`id`)) ENGINE=InnoDB DEFAULT CHARSET=latin1;

INSERT INTO WORKING_TABLE SELECT f.id, f.observation_period, g.event_type_num AS event_type, f.observation_period_T, f.time_start, f.time_end, IF(f.observation_period<20,5,1) FROM  ( SELECT c.id, c.claimnumber AS observation_period, REPLACE(c.event_type, ' ', '') AS event_type, e.observation_period_T, c.time_start, c.time_end FROM  	( 	SELECT b.id, b.claimnumber, b.event_type, TIMESTAMPDIFF(HOUR, a.mintime, b.ts)+1 as time_start, TIMESTAMPDIFF(HOUR, a.mintime, b.ts)+1 as time_end 	FROM 		( 		SELECT claimnumber, MIN(ts) as mintime 		FROM ORIGINAL_TABLE 		GROUP BY claimnumber 		) a, 		ORIGINAL_TABLE b 	WHERE a.claimnumber=b.claimnumber 	) c, 	( 	SELECT claimnumber, MAX(time_start) as observation_period_T 	FROM 		( 		SELECT bb.id, bb.claimnumber, bb.event_type, TIMESTAMPDIFF(HOUR, aa.mintime, bb.ts)+1 as time_start, TIMESTAMPDIFF(HOUR, aa.mintime, bb.ts)+1 as time_end 		FROM 			( 			SELECT claimnumber, MIN(ts) as mintime 			FROM ORIGINAL_TABLE 			GROUP BY claimnumber 			) aa, 			ORIGINAL_TABLE bb 		WHERE aa.claimnumber=bb.claimnumber 		) d 	GROUP BY claimnumber 	) e WHERE c.claimnumber=e.claimnumber ) f,  ( SELECT @n := @n + 1 event_type_num, event_type FROM (SELECT DISTINCT REPLACE(event_type, ' ', '') AS event_type FROM ORIGINAL_TABLE ORDER BY event_type) a, (SELECT @n := 0) b ) g  WHERE f.event_type=g.event_type